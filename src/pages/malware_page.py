import pandas as pd
import numpy as np
import streamlit as st
import plotly.express as px
import plotly.graph_objects as go
import hydralit as hy
from hydralit import HydraHeadApp
from definition.malware_definitions import malware_dict

class type_malware(HydraHeadApp):
    def run(self):
        data = pd.read_csv("src/data/malwares.csv")
        titel_general = st.container()
        with titel_general:
            col1, col2 = st.columns([3, 7])
            col1.title("üëæAN√ÅLISIS DE TIPOS DE MALWARE")
            col1.subheader(
                "üìçEn este apartado se encuentra informacion individual sobre cada tipo de malware"
            )
            options = data["Malware"].unique()
            malware_selected = col1.selectbox("Seleccionar tipo de Malware", options)
            num_malware = len(options)
            st.write(f"N√∫mero de Malwares recolectados por Medalware: {num_malware}")
            st.header(f"Informaci√≥n sobre el malware seleccionado: {malware_selected}")
            # Obtener la definici√≥n y el tipo de la familia de malware seleccionada
            selected_data = data[data["Malware"] == malware_selected]           
            selected_data["Fecha"] = pd.to_datetime(selected_data["Fecha"])
            # Contar la cantidad de filas para cada d√≠a
        data_grouped_extension = (
        selected_data.groupby(selected_data["Fecha"].dt.date)
        .size()
        .reset_index(name="cantidad")
        )

            # Crear el gr√°fico de √°rea con Plotly Express
        fig4 = px.area(data_grouped_extension, x="Fecha", y="cantidad")

            # Personalizar el dise√±o del gr√°fico de √°rea
        fig4.update_layout(
            title="Cantidad de Malware por D√≠a",
            xaxis_title="Fecha",
            yaxis_title="Cantidad de Malware",
        )
        histograma_malware = col2.container()
        with histograma_malware:
            col1, col2, col3 = st.columns([0.1, 4, 0.1])
            col2.plotly_chart(
                fig4,
                config={"displaylogo": False},
                use_container_width=True,
                width=800,
                height=400,
                )
        st.divider() 
        definicion = next(
            (
                item["Definicion"]
                for item in malware_dict
                if item["Malware"] == malware_selected
            ),
            None,
        )
        familia = next(
            (
               item["Familia"]
               for item in malware_dict
               if item["Malware"] == malware_selected
            ),
            None,
        )
        sistema_op = next(
            (
                item["SO"]
                for item in malware_dict
                if item["Malware"] == malware_selected
            ),
            None,
        )
        definicion_malware = st.container()
        with definicion_malware:
            if definicion:
                st.subheader("Definici√≥n del Malware")
                st.write(definicion)

            if familia:
                st.subheader("Familia")
                st.write(familia)

            if sistema_op:
                st.subheader("SO")
                st.write(sistema_op)

            # Filtrar los datos por la familia de malware seleccionada
            # selected_data = data[data["Malware"] == malware_selected]

            # Mostrar la tabla con los datos filtrados
        st.subheader("Tabla de Malwares")
        col1, col2, col3 = st.columns([0.1, 4, 0.1])
        col2.write(
            selected_data[
                [
                    "Fecha",
                    "SHA256",
                    "Malware",
                    "Familia",
                    "SO",
                    "Metodo de Entrega",
                    "Extension",
                    "Peso",
                    "Origen",
                ]
            ]
        )

            # Contar la cantidad de filas para cada m√©todo de entrega
        data_grouped_metodo = selected_data["Metodo de Entrega"].value_counts()

            # Crear el gr√°fico de torta para m√©todo de entrega con plotly.graph_objects
        fig1 = go.Figure(
                data=[
                    go.Pie(
                        labels=data_grouped_metodo.index,
                        values=data_grouped_metodo.values,
                    )
                ]
            )
        # Personalizar Colores de las gr√°ficas de torta
        colors = px.colors.qualitative.G10
            # Personalizar el dise√±o del gr√°fico de torta para m√©todo de entrega
        fig1.update_traces(
                textposition="inside",
                textinfo="percent+label",
                textfont_size=12,
                marker=dict(colors=colors, line=dict(color=colors, width=2)),
            )

        fig1.update_layout(
                title="M√©todo de Entrega",
                width=400,
                height=400,
                margin=dict(l=10, r=10, t=30, b=10),
            )

        # Contar la cantidad de filas para cada extensi√≥n
        data_grouped_extension = selected_data["Extension"].value_counts()

        # Crear el gr√°fico de torta para extensi√≥n con plotly.graph_objects
        fig2 = go.Figure(
                data=[
                    go.Pie(
                        labels=data_grouped_extension.index,
                        values=data_grouped_extension.values,
                    )
                ]
            )

        # Personalizar el dise√±o del gr√°fico de torta para extensi√≥n
        fig2.update_traces(
                textposition="inside",
                textinfo="percent+label",
                textfont_size=12,
                marker=dict(colors=colors, line=dict(color=colors, width=2)),
            )

        fig2.update_layout(
                title="Extensi√≥n",
                width=400,
                height=400,
                margin=dict(l=10, r=10, t=30, b=10),
            )

            # Crear la primera columna con los dos gr√°ficos de torta
        col1, col2 = st.columns([3, 2])
        with col1:
            st.plotly_chart(fig1)
            st.plotly_chart(fig2)

        # Contar la cantidad de filas para cada m√©todo de origen
        data_grouped_metodo = selected_data["Origen"].value_counts()

        # Crear el gr√°fico de torta para m√©todo de entrega con plotly.graph_objects
        fig3 = go.Figure(
                data=[
                    go.Pie(
                        labels=data_grouped_metodo.index,
                        values=data_grouped_metodo.values,
                    )
                ]
            )

        # Personalizar el dise√±o del gr√°fico de torta para m√©todo de entrega
        fig3.update_traces(
                textposition="inside",
                textinfo="percent+label",
                textfont_size=12,
                marker=dict(colors=colors, line=dict(color=colors, width=2)),
            )

        fig3.update_layout(
                title="Origen",
                width=400,
                height=400,
                margin=dict(l=10, r=10, t=30, b=10),
            )

        selected_data["Fecha"] = pd.to_datetime(selected_data["Fecha"])
        # Contar la cantidad de filas para cada d√≠a
        data_grouped_extension = (
                selected_data.groupby(selected_data["Fecha"].dt.date)
                .size()
                .reset_index(name="cantidad")
            )

        # Crear el gr√°fico de √°rea con Plotly Express
        fig4 = px.area(data_grouped_extension, x="Fecha", y="cantidad")

        # Personalizar el dise√±o del gr√°fico de √°rea
        fig4.update_layout(
                title="Cantidad de Malware por D√≠a",
                xaxis_title="Fecha",
                yaxis_title="Cantidad de Malware",
            )

        # Crear la segunda columna con los dos gr√°ficos de torta
        with col2:
            st.plotly_chart(fig3)
            st.plotly_chart(fig4)
