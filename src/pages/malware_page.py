import pandas as pd
import numpy as np
import streamlit as st
import plotly.express as px
import plotly.graph_objects as go
import hydralit as hy
from hydralit import HydraHeadApp
from definition.malware_definitions import malware_dict
from streamlit_extras.add_vertical_space import add_vertical_space


class type_malware(HydraHeadApp):
    def run(self):
        data = pd.read_csv("src/data/malwares.csv")
        title_general = st.container()
        with title_general:
            col1, col2 = st.columns([3, 7])
            col1.title("AN츼LISIS DE DATOS DE MALWARE")
            col1.subheader(
                "游늷En este apartado se encuentra informaci칩n individual sobre cada tipo de malware"
            )
            options = data["Malware"].unique()
            malware_selected = col1.selectbox("游녢Selecciona un tipo de Malware游녢", options)

            # num_malware = len(options)

            # Obtener la definici칩n y el tipo de la familia de malware seleccionada
            selected_data = data[data["Malware"] == malware_selected]
            selected_data["Fecha"] = pd.to_datetime(selected_data["Fecha"])

            # Contar la cantidad de filas para cada d칤a
            data_grouped_extension = (
                selected_data.groupby(selected_data["Fecha"].dt.date)
                .size()
                .reset_index(name="cantidad")
            )

        # Crear el gr치fico de 치rea con Plotly Express
        fig1 = px.histogram(data_grouped_extension, x="Fecha", y="cantidad", nbins=50)

        # Personalizar el dise침o del gr치fico de 치rea
        fig1.update_layout(
            title=f"REGISTROS DEL MALWARE {malware_selected.upper()}",
            title_x=0.0,
            xaxis_title="Fecha",
            yaxis_title=" Cantidad de Ocurrencias",
        )

        histograma_malware = col2.container()
        with histograma_malware:
            col1, col2, col3 = st.columns([0.1, 4, 0.1])
            col2.plotly_chart(
                fig1,
                config={"displaylogo": False},
                use_container_width=True,
                width=800,
                height=400,
            )
        st.divider()

        definicion = next(
            (
                item["Definicion"]
                for item in malware_dict
                if item["Malware"] == malware_selected
            ),
            None,
        )
        familia = next(
            (
                item["Familia"]
                for item in malware_dict
                if item["Malware"] == malware_selected
            ),
            None,
        )
        sistema_op = next(
            (
                item["SO"]
                for item in malware_dict
                if item["Malware"] == malware_selected
            ),
            None,
        )

        title_familia = st.container()
        with title_familia:
            # colt1, colt2, colt3 = st.columns([7,5,7])
            col1, col2 = st.columns([6, 5])
            col4, col5, col6 = st.columns([1, 10, 1])
            col1.markdown(
                f"""
                <div style="text-align: left">
                <h1>驕勇끝malware_selected}驕勇
                """,
                unsafe_allow_html=True,
            )

            if definicion:
                col2.markdown(
                    f"""
                <div style="text-align: justify">
                <h4>{definicion}
                """,
                    unsafe_allow_html=True,
                )

            col1.markdown(
                f"""
                <div style="text-align: left">
                <h4> 拘勇游늼 Informaci칩n analizada a partir de los datos de {malware_selected}
                """,
                unsafe_allow_html=True,
            )
        tag_selector = st.container()
        with tag_selector:
            tab1, tab2, tab3, tab4 = st.tabs(
                [
                    "       游늳Registros",
                    "       游늭Familia",
                    "       游늵Caracter칤sticas",
                    "       游깵Origen",
                ]
            )
            
        total_datos = data["Malware"].value_counts().sum()
        porcentajes = selected_data["Malware"].value_counts() / total_datos * 100

        registro_malware = st.container()
        with registro_malware:
            tab1.markdown(
                f"""
                    <div style="text-align: center">
                    <h4>游댫Medalware ha recopilado datos de {selected_data.shape[0]}
                    archivos del malware {malware_selected} que corresponden al 
                    {porcentajes.iloc[0].round(2)}% de los malwares globales analizados
                    por la aplicacion游댫 
                """,
                unsafe_allow_html=True,
            )
            if familia:
                tab2.markdown(
                    f"""
                    <div style="text-align: justify">
                    <h3>游댲Medalware ha clasificado al malware
                    '{malware_selected}' como perteneciente a la familia de los {familia} 

                    """,
                    unsafe_allow_html=True,
                )
            col1_2, col2_2, col3_2, col4_2 = tab3.columns([4, 4, 4, 4])
            caracteristicas = tab3.container()
            with caracteristicas:
                if sistema_op:
                    col1_2.markdown(
                        f"""
                        <div style="text-align: center">
                        <h4>游댮{malware_selected} es un malware que 
                        afecta principalmente a sistemas {sistema_op.title()}
                        """,
                        unsafe_allow_html=True,
                    )
                col2_2.markdown(
                    f"""
                        <div style="text-align: center">
                        <h4>游맡malware_selected.title()} se ejecuta bajo
                        archivos de extensi칩n .{selected_data["Extension"].value_counts().idxmax()}
                        """,
                    unsafe_allow_html=True,
                )
                col4_2.markdown(
                    f"""
                        <div style="text-align: center">
                        <h4>游릭El peso promedio de los archivos con {malware_selected.title()} 
                        es de {selected_data["Peso"].mean().round(2)} KB
                        """,
                    unsafe_allow_html=True,
                )
                col3_2.markdown(
                    f"""
                        <div style="text-align: center">
                        <h4>游리Este tipo de malware llega a los sistemas a trav칠s de
                        {selected_data["Metodo de Entrega"].value_counts().idxmax()}
                        """,
                    unsafe_allow_html=True,
                )
            col1_m, col2_m = tab4.columns([7, 3])
            origen_tab4 = st.container()
            with origen_tab4:
                col1_m.markdown(
                    f"""
                            <div style="text-align: center">
                            <h4>游닕Los datos recopilados a partir de los registros
                            del malware {malware_selected}, indican que este software malicioso
                            ha visto mayor prescencia en  {selected_data["Origen"].value_counts().idxmax()}

                            <h6> Nota: Medalware clasifica los paises tomando como referencia la normativa ISO 3166-1, alpha-3
                            """,
                    unsafe_allow_html=True,
                )

        data_grouped_mapa = selected_data["Origen"].value_counts()

        # Crear el DataFrame con los datos de cantidad por origen
        data_map = pd.DataFrame(
            {"iso_alpha": data_grouped_mapa.index, "cantidad": data_grouped_mapa.values}
        )

        # Crear el gr치fico de mapa coropl칠tico interactivo
        fig5 = px.choropleth(
            data_frame=data_map,
            locations="iso_alpha",
            locationmode="ISO-3",
            color="cantidad",
            color_continuous_scale="portland",
            labels={"cantidad": "Cantidad"},
            projection="equirectangular",
        )

        fig5.update_geos(
            showland=True,
            showocean=True,
            showcountries=True,
            showframe=True,
            landcolor="white",
            oceancolor="white",
            bgcolor="rgba(0,0,0,0)",
        )

        fig5.update_layout(width=550, height=500)

        mapa_malwares = st.container()
        with mapa_malwares:
            col1_m.plotly_chart(
                fig5, config={"displaylogo": False}, use_container_width=True
            )

        tabla_malwares = tab1.container()
        with tabla_malwares:
            col1, col2, col3 = st.columns([0.1, 4, 0.1])
            col2.markdown(
                f"""
            <div style="text-align: center">
            <h4> 游늶拘勇뀺abla de Registro de datos recopilados de {malware_selected}拘勇游늶  
            """,
                unsafe_allow_html=True,
            )

            col2.write(
                selected_data[
                    [
                        "Fecha",
                        "SHA256",
                        "Malware",
                        "Familia",
                        "SO",
                        "Metodo de Entrega",
                        "Extension",
                        "Peso",
                        "Origen",
                    ]
                ]
            )

        # Obtener la familia del malware seleccionado
        familia_seleccionada = selected_data["Familia"].iloc[0]
        # Filtrar los datos para incluir solo los malwares de la misma familia
        malwares_misma_familia = data[data["Familia"] == familia_seleccionada]
        # Agrupar los malwares por nombre y contar la cantidad de ocurrencias de cada uno
        datos_agrupados = malwares_misma_familia["Malware"].value_counts().reset_index()
        datos_agrupados.columns = ["Malware", "Cantidad"]
        # Calcular la cantidad total de malwares de la misma familia
        total_malwares_familia = datos_agrupados["Cantidad"].sum()
        # Calcular el porcentaje del malware seleccionado en comparaci칩n con otros de la misma familia
        porcentaje_seleccionado = (
            selected_data.shape[0] / total_malwares_familia
        ) * 100

        # Mostrar el porcentaje en Streamlit
        tab2.markdown(
            f"""
                <div style="text-align: justify">
                <h4>游댲{malware_selected} adem치s, abarca un {porcentaje_seleccionado:.2f}%
                de los registros de toda esta familia de malwares""",
            unsafe_allow_html=True,
        )
        # Crear la gr치fica de dispersi칩n
        fig5 = px.bar(
            datos_agrupados,
            x="Malware",
            y="Cantidad",
            title=f"游댵Gr치fica de los malware pertencientes a la familia: {familia}游댵",
        )
        # Personalizar el dise침o de la gr치fica
        fig5.update_layout(xaxis_title="Malware", yaxis_title="Cantidad", title_x=0.35)

        # Mostrar la gr치fica en Streamlit
        familias_malwares = st.container()
        with familias_malwares:
            tab2.plotly_chart(
                fig5,
                config={"displayModeBar": False},
                use_container_width=True,
                width=800,
                height=400,
            )
        # Personalizar Colores de las gr치ficas de torta
        colors = px.colors.qualitative.G10

        # Contar la cantidad de filas para cada Sistema operativo
        data_grouped_origen = selected_data["SO"].value_counts()
        # Crear el gr치fico de torta para Sistema operativo con plotly.graph_objects
        fig7 = go.Figure(
            data=[
                go.Pie(
                    labels=data_grouped_origen.index,
                    values=data_grouped_origen.values,
                )
            ]
        )

        # Personalizar el dise침o del gr치fico de torta para Sistema operativo
        fig7.update_traces(
            textposition="inside",
            textinfo="percent+label",
            textfont_size=12,
            marker=dict(colors=colors, line=dict(color=colors, width=2)),
        )
        fig7.update_layout(
            width=300,
            height=200,
            margin=dict(l=10, r=10, t=30, b=10),
        )

        # Contar la cantidad de filas para cada Sistema operativo
        data_grouped_origen = selected_data["Extension"].value_counts()
        # Crear el gr치fico de torta para Sistema operativo con plotly.graph_objects
        fig8 = go.Figure(
            data=[
                go.Pie(
                    labels=data_grouped_origen.index,
                    values=data_grouped_origen.values,
                )
            ]
        )

        # Personalizar el dise침o del gr치fico de torta para Sistema operativo
        fig8.update_traces(
            textposition="inside",
            textinfo="percent+label",
            textfont_size=12,
            marker=dict(colors=colors, line=dict(color=colors, width=2)),
        )
        fig8.update_layout(
            width=300,
            height=200,
            margin=dict(l=10, r=10, t=30, b=10),
        )
        # Contar la cantidad de filas para cada Sistema operativo
        data_grouped_origen = selected_data["Metodo de Entrega"].value_counts()
        # Crear el gr치fico de torta para Sistema operativo con plotly.graph_objects
        fig9 = go.Figure(
            data=[
                go.Pie(
                    labels=data_grouped_origen.index,
                    values=data_grouped_origen.values,
                )
            ]
        )

        # Personalizar el dise침o del gr치fico de torta para Sistema operativo
        fig9.update_traces(
            textposition="inside",
            textinfo="percent+label",
            textfont_size=12,
            marker=dict(colors=colors, line=dict(color=colors, width=2)),
        )
        fig9.update_layout(
            width=300,
            height=200,
            margin=dict(l=10, r=10, t=30, b=10),
        )

        fig_peso = px.box(selected_data, y="Peso", labels={"y": "Peso"})
        fig_peso.update_layout(
            width=300,
            height=450,
        )

        grafica_pie = tab3.container()
        with grafica_pie:
            space = col1_2.container()
            with space:
                add_vertical_space(2)
            col1_2.plotly_chart(fig7, config={"displaylogo": False})
            space = col2_2.container()
            with space:
                add_vertical_space(4)
            col2_2.plotly_chart(fig8, config={"displaylogo": False})
            col4_2.plotly_chart(fig_peso, config={"displaylogo": False})
            space = col3_2.container()
            with space:
                add_vertical_space(2)
            col3_2.plotly_chart(fig9, config={"displaylogo": False})
